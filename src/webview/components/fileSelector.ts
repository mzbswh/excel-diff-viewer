import { MessageToExtension } from '../../shared/message';

export class FileSelector {
  private app: any;
  private oldFilePath: string | null = null;
  private newFilePath: string | null = null;
  private oldFileSize: number = 0;
  private newFileSize: number = 0;

  constructor(app: any) {
    this.app = app;
  }

  public initialize(): void {
    this.bindEvents();
    this.setupDragDrop();
    this.preventDefaultDragBehavior();
    this.initializeTheme();
  }

  private initializeTheme(): void {
    // ÂàùÂßãÂåñ‰∏ªÈ¢òÂõæÊ†áÊòæÁ§∫
    // ‰ªé localStorage Âä†ËΩΩ‰∏ªÈ¢òËÆæÁΩÆ
    const settings = JSON.parse(localStorage.getItem('excelDiffViewerSettings') || '{}');
    const currentTheme = settings.theme || 'auto'; // ÈªòËÆ§‰∏∫ 'auto'
    
    // Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øù DOM Â∑≤ÂáÜÂ§áÂ•Ω
    setTimeout(() => {
      const toolbar = (this.app as any).toolbar;
      if (toolbar) {
        // Á°Æ‰øù toolbar ‰ΩøÁî®Ê≠£Á°ÆÁöÑ‰∏ªÈ¢òËÆæÁΩÆ
        toolbar.currentTheme = currentTheme;
        if (typeof toolbar.updateTheme === 'function') {
          toolbar.updateTheme();
        }
      }
    }, 0);
  }

  private preventDefaultDragBehavior(): void {
    // Âú®Êï¥‰∏™ÊñáÊ°£Á∫ßÂà´ÈòªÊ≠¢ÈªòËÆ§ÁöÑÊãñÊãΩË°å‰∏∫ÔºåÈò≤Ê≠¢VSCodeÊâìÂºÄÊñá‰ª∂
    ['dragenter', 'dragover', 'drop'].forEach(eventName => {
      document.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    // Èò≤Ê≠¢ÊãñÊãΩÁ¶ªÂºÄÁ™óÂè£
    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
    }, false);
  }

  private bindEvents(): void {
    // ÁÇπÂáª‰∫ã‰ª∂ÂßîÊâò
    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      
      // ÂÖàÊ£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÁßªÈô§ÊåâÈíÆÔºà‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºâ
      if (target.id === 'remove-file-a' || target.closest('#remove-file-a')) {
        event.stopPropagation();
        this.removeFile('old');
        return;
      }
      if (target.id === 'remove-file-b' || target.closest('#remove-file-b')) {
        event.stopPropagation();
        this.removeFile('new');
        return;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÂ§çÂà∂Ë∑ØÂæÑÊåâÈíÆ
      if (target.id === 'btn-copy-path-a' || target.closest('#btn-copy-path-a')) {
        event.stopPropagation();
        this.copyPath('old');
        return;
      }
      if (target.id === 'btn-copy-path-b' || target.closest('#btn-copy-path-b')) {
        event.stopPropagation();
        this.copyPath('new');
        return;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜdropzoneÂå∫ÂüüÔºàÂåÖÊã¨ÂÖ∂Â≠êÂÖÉÁ¥†Ôºâ
      const clickedDropzoneA = target.closest('#dropzone-a');
      const clickedDropzoneB = target.closest('#dropzone-b');
      
      if (clickedDropzoneA) {
        this.selectFile('old');
        return;
      }
      if (clickedDropzoneB) {
        this.selectFile('new');
        return;
      }
      
      // ÂºÄÂßãÂØπÊØîÊåâÈíÆ
      if (target.id === 'btn-start-compare' || target.closest('#btn-start-compare')) {
        this.startComparison();
        return;
      }
      
      // ËèúÂçïÈ°π
      if (target.id === 'menu-open-file-a') {
        this.selectFile('old');
        return;
      }
      if (target.id === 'menu-open-file-b') {
        this.selectFile('new');
        return;
      }
      if (target.id === 'menu-clear-all') {
        this.clearAllFiles();
        return;
      }
      // ‰ΩøÁî® closest() Â§ÑÁêÜÂ≠êÂÖÉÁ¥†‰∏äÁöÑÁÇπÂáª
      const themeButton = target.closest('#menu-theme-toggle');
      if (themeButton) {
        this.toggleTheme();
        return;
      }
    });
  }

  private setupDragDrop(): void {
    const setupDropzone = (dropzoneId: string, fileType: 'old' | 'new') => {
      const dropzone = document.getElementById(dropzoneId);
      if (!dropzone) return;

      // ÊãñÊãΩËøõÂÖ• - ËÆæÁΩÆ dropEffect ÂëäËØâ VS Code Êàë‰ª¨Ë¶ÅÂ§ÑÁêÜËøô‰∏™ÊãñÊãΩ
      dropzone.addEventListener('dragenter', (e: Event) => {
        const dragEvent = e as DragEvent;
        e.preventDefault();
        e.stopPropagation();
        
        // ËÆæÁΩÆ‰∏∫ 'copy' Ë°®Á§∫Êàë‰ª¨Ë¶ÅÂ§ÑÁêÜËøô‰∏™Êñá‰ª∂Ôºå‰∏çË¶ÅËÆ© VS Code ÊâìÂºÄÂÆÉ
        if (dragEvent.dataTransfer) {
          dragEvent.dataTransfer.dropEffect = 'copy';
        }
        
        dropzone.classList.add('dropzone-drag-over');
      });

      // ÊãñÊãΩÊÇ¨ÂÅú - ÊåÅÁª≠ËÆæÁΩÆ dropEffect
      dropzone.addEventListener('dragover', (e: Event) => {
        const dragEvent = e as DragEvent;
        e.preventDefault();
        e.stopPropagation();
        
        // ÂøÖÈ°ªÂú® dragover ‰∏≠ÊåÅÁª≠ËÆæÁΩÆ dropEffect
        if (dragEvent.dataTransfer) {
          dragEvent.dataTransfer.dropEffect = 'copy';
        }
        
        dropzone.classList.add('dropzone-drag-over');
      });

      // ÊãñÊãΩÁ¶ªÂºÄ
      dropzone.addEventListener('dragleave', (e: Event) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dropzone-drag-over');
      });

      // Êñá‰ª∂Êîæ‰∏ã
      dropzone.addEventListener('drop', (e: Event) => {
        const dropEvent = e as DragEvent;
        e.preventDefault();
        e.stopPropagation();
        
        dropzone.classList.remove('dropzone-drag-over');
        
        const files = dropEvent.dataTransfer?.files;
        
        if (files && files.length > 0) {
          const file = files[0];
          // È™åËØÅÊñá‰ª∂Ê†ºÂºè
          if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            // ÈÄöËøápostMessageËÆ©Êâ©Â±ïÁ´ØÂ§ÑÁêÜÊñá‰ª∂
            // Ê≥®ÊÑèÔºöWebView‰∏≠Êó†Ê≥ïÁõ¥Êé•ËØªÂèñÊñá‰ª∂Ë∑ØÂæÑÔºåÈúÄË¶ÅÊâ©Â±ïÁ´ØÂ§ÑÁêÜ
            this.handleFileDrop(fileType, file);
          } else {
            this.showError('ËØ∑ÈÄâÊã© .xlsx Êàñ .xls Ê†ºÂºèÁöÑÊñá‰ª∂');
          }
        }
      });
    };

    setupDropzone('dropzone-a', 'old');
    setupDropzone('dropzone-b', 'new');
  }

  private handleFileDrop(fileType: 'old' | 'new', file: File): void {
    // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
    const isExcelFile = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    
    if (!isExcelFile) {
      this.showError('ËØ∑ÊãñÊãΩ Excel Êñá‰ª∂Ôºà.xlsx Êàñ .xlsÔºâ');
      return;
    }
    
    console.log(`Ê£ÄÊµãÂà∞ Excel Êñá‰ª∂: ${file.name}`);
    
    // Â∞ùËØïËé∑ÂèñÊñá‰ª∂Ë∑ØÂæÑÔºàElectron ÁâπÊÄßÔºå‰ΩÜÂèØËÉΩ‰∏çÂèØÁî®Ôºâ
    const filePath = (file as any).path;
    
    if (filePath) {
      // ÊñπÊ≥ï1ÔºöÂ¶ÇÊûúËÉΩËé∑ÂèñË∑ØÂæÑÔºåÁõ¥Êé•ÂèëÈÄÅË∑ØÂæÑ
      console.log(`‚úÖ ‰ΩøÁî®Êñá‰ª∂Ë∑ØÂæÑ: ${filePath}`);
      this.app.postMessage({
        kind: 'fileDropped',
        fileType: fileType,
        filePath: filePath,
        fileName: file.name,
        fileSize: file.size
      });
    } else {
      // ÊñπÊ≥ï2ÔºöÊó†Ê≥ïËé∑ÂèñË∑ØÂæÑÔºå‰ΩøÁî® FileReader ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
      console.log('üìñ Êó†Ê≥ïËé∑ÂèñË∑ØÂæÑÔºå‰ΩøÁî® FileReader ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ');
      this.readFileContent(fileType, file);
    }
  }

  private readFileContent(fileType: 'old' | 'new', file: File): void {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const arrayBuffer = e.target?.result as ArrayBuffer;
      if (arrayBuffer) {
        // Â∞Ü ArrayBuffer ËΩ¨Êç¢‰∏∫ Base64
        const base64 = this.arrayBufferToBase64(arrayBuffer);
        
        console.log(`‚úÖ Êñá‰ª∂ËØªÂèñÊàêÂäüÔºåÂ§ßÂ∞è: ${file.size} Â≠óËäÇ`);
        
        // ÂèëÈÄÅÊñá‰ª∂ÂÜÖÂÆπÂà∞Êâ©Â±ïÁ´Ø
        this.app.postMessage({
          kind: 'fileContentDropped',
          fileType: fileType,
          fileName: file.name,
          fileSize: file.size,
          fileContent: base64
        });
      }
    };
    
    reader.onerror = () => {
      console.error('‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
      this.showError('ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑‰ΩøÁî®ÁÇπÂáªÈÄâÊã©ÊñπÂºè');
    };
    
    // ËØªÂèñÊñá‰ª∂‰∏∫ ArrayBuffer
    reader.readAsArrayBuffer(file);
  }

  private arrayBufferToBase64(buffer: ArrayBuffer): string {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  private showDropHint(fileType: 'old' | 'new', fileName: string): void {
    // Âú®ÊãñÊãΩÂå∫ÊòæÁ§∫ÊèêÁ§∫ÔºöËØ∑Âú®Êñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°Ü‰∏≠ÈÄâÊã©ËØ•Êñá‰ª∂
    const suffix = fileType === 'old' ? 'a' : 'b';
    const dropzoneContent = document.getElementById(`dropzone-content-${suffix}`);
    
    if (dropzoneContent) {
      const hint = document.createElement('div');
      hint.className = 'drop-hint';
      hint.textContent = `Ê≠£Âú®ÊâìÂºÄÊñá‰ª∂ÈÄâÊã©Âô®...`;
      hint.style.cssText = 'color: var(--primary-color); font-size: 12px; margin-top: 8px;';
      
      dropzoneContent.appendChild(hint);
      
      // 3ÁßíÂêéÁßªÈô§ÊèêÁ§∫
      setTimeout(() => {
        hint.remove();
      }, 3000);
    }
  }

  private selectFile(fileType: 'old' | 'new'): void {
    this.app.postMessage({
      kind: 'selectFile',
      fileType: fileType
    });
  }

  public handleFileSelected(fileType: 'old' | 'new', filePath: string, fileName: string, fileSize?: number, fileTime?: string): void {
    const suffix = fileType === 'old' ? 'a' : 'b';
    const dropzoneContent = document.getElementById(`dropzone-content-${suffix}`);
    const fileInfo = document.getElementById(`file-info-${suffix}`);
    const fileNameEl = document.getElementById(`file-name-${suffix}`);
    const filePathEl = document.getElementById(`file-path-${suffix}`);
    const fileSizeEl = document.getElementById(`file-size-${suffix}`);
    const fileTimeEl = document.getElementById(`file-time-${suffix}`);

    if (!dropzoneContent || !fileInfo || !fileNameEl || !filePathEl) {
      console.error('Required DOM elements not found');
      return;
    }

    // Êõ¥Êñ∞Êñá‰ª∂‰ø°ÊÅØ
    fileNameEl.textContent = fileName;
    filePathEl.textContent = filePath;
    
    // Êõ¥Êñ∞Êñá‰ª∂Â§ßÂ∞è
    if (fileSizeEl) {
      if (fileSize !== undefined) {
        fileSizeEl.textContent = this.formatFileSize(fileSize);
        fileSizeEl.style.display = '';
        if (fileType === 'old') {
          this.oldFileSize = fileSize;
        } else {
          this.newFileSize = fileSize;
        }
      } else {
        fileSizeEl.textContent = '';
        fileSizeEl.style.display = 'none';
      }
    }
    
    // Êõ¥Êñ∞Êñá‰ª∂Êó∂Èó¥
    if (fileTimeEl) {
      if (fileTime) {
        fileTimeEl.textContent = fileTime;
        fileTimeEl.style.display = '';
      } else {
        fileTimeEl.textContent = '';
        fileTimeEl.style.display = 'none';
      }
    }

    // Êõ¥Êñ∞ÂàÜÈöîÁ¨¶ÊòæÁ§∫ÔºàÂè™ÊúâÂΩì‰∏§‰∏™‰ø°ÊÅØÈÉΩÊúâÊó∂ÊâçÊòæÁ§∫Ôºâ
    const metaDivider = document.querySelector(`#file-info-${suffix} .meta-divider`) as HTMLElement;
    if (metaDivider) {
      const hasSize = fileSize !== undefined;
      const hasTime = fileTime !== undefined && fileTime !== '';
      metaDivider.style.display = (hasSize && hasTime) ? '' : 'none';
    }

    // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØÔºåÈöêËóèdropzoneÊèêÁ§∫
    dropzoneContent.classList.add('hidden');
    fileInfo.classList.remove('hidden');

    // Â≠òÂÇ®Êñá‰ª∂Ë∑ØÂæÑ
    if (fileType === 'old') {
      this.oldFilePath = filePath;
    } else {
      this.newFilePath = filePath;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
    this.updateStatusBar();
  }

  private removeFile(fileType: 'old' | 'new'): void {
    const suffix = fileType === 'old' ? 'a' : 'b';
    const dropzoneContent = document.getElementById(`dropzone-content-${suffix}`);
    const fileInfo = document.getElementById(`file-info-${suffix}`);

    if (dropzoneContent && fileInfo) {
      // ÈöêËóèÊñá‰ª∂‰ø°ÊÅØÔºåÊòæÁ§∫dropzoneÊèêÁ§∫
      fileInfo.classList.add('hidden');
      dropzoneContent.classList.remove('hidden');
    }

    // Ê∏ÖÈô§Êñá‰ª∂Ë∑ØÂæÑ
    if (fileType === 'old') {
      this.oldFilePath = null;
      this.oldFileSize = 0;
    } else {
      this.newFilePath = null;
      this.newFileSize = 0;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
    this.updateStatusBar();
  }

  private clearAllFiles(): void {
    this.removeFile('old');
    this.removeFile('new');
  }

  private copyPath(fileType: 'old' | 'new'): void {
    const path = fileType === 'old' ? this.oldFilePath : this.newFilePath;
    if (path) {
      navigator.clipboard.writeText(path).then(() => {
        this.showToast(`Â§çÂà∂ÊàêÂäüÔºö${path}`);
      }).catch(() => {
        this.showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
      });
    }
  }

  private showToast(message: string): void {
    const toast = document.getElementById('copy-toast');
    const toastText = toast?.querySelector('.toast-text');
    
    if (toast && toastText) {
      toastText.textContent = message;
      toast.classList.remove('hidden', 'toast-hide');
      
      // 2ÁßíÂêéÈöêËóè
      setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 300); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
      }, 2000);
    }
  }

  private toggleTheme(): void {
    // Á°Æ‰øù toolbar Â∑≤ÂàùÂßãÂåñÂÜçËøõË°åÂßîÊâò
    const toolbar = (this.app as any).toolbar;
    if (toolbar && typeof toolbar.toggleTheme === 'function') {
      toolbar.toggleTheme();
    } else {
      console.error('Toolbar Êú™ÂàùÂßãÂåñÊàñ toggleTheme ÊñπÊ≥ï‰∏çÂèØÁî®');
    }
  }

  private updateStatusBar(): void {
    const fileCountEl = document.getElementById('file-count-status');
    const fileSizeEl = document.getElementById('file-size-status');
    const compareBtn = document.getElementById('btn-start-compare') as HTMLButtonElement;
    const statusIndicator = document.getElementById('status-indicator');

    // Êõ¥Êñ∞Êñá‰ª∂ËÆ°Êï∞
    const fileCount = (this.oldFilePath ? 1 : 0) + (this.newFilePath ? 1 : 0);
    if (fileCountEl) {
      fileCountEl.textContent = `Â∑≤ÈÄâÊã©: ${fileCount}/2 ‰∏™Êñá‰ª∂`;
    }

    // Êõ¥Êñ∞ÊÄªÊñá‰ª∂Â§ßÂ∞è
    if (fileSizeEl) {
      const totalSize = this.oldFileSize + this.newFileSize;
      if (totalSize > 0) {
        fileSizeEl.textContent = `ÊÄªÂ§ßÂ∞è: ${this.formatFileSize(totalSize)}`;
      } else {
        fileSizeEl.textContent = '';
      }
    }

    // Êõ¥Êñ∞ÂØπÊØîÊåâÈíÆÁä∂ÊÄÅ
    if (compareBtn) {
      const canCompare = this.oldFilePath && this.newFilePath;
      compareBtn.disabled = !canCompare;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÊèêÁ§∫
    const statusHint = document.getElementById('status-hint');
    if (statusHint) {
      if (fileCount === 2) {
        statusHint.textContent = '‚úì Â∑≤Â∞±Áª™ÔºåÁÇπÂáªÊåâÈíÆÂºÄÂßãÂØπÊØî';
        statusHint.style.color = 'var(--success-color)';
      } else if (fileCount === 1) {
        statusHint.textContent = `ËøòÈúÄÈÄâÊã© ${2 - fileCount} ‰∏™Êñá‰ª∂`;
        statusHint.style.color = 'var(--text-secondary)';
      } else {
        statusHint.textContent = 'ËØ∑ÈÄâÊã©‰∏§‰∏™ExcelÊñá‰ª∂ËøõË°åÂØπÊØî';
        statusHint.style.color = 'var(--text-secondary)';
      }
    }
  }

  private startComparison(): void {
    if (!this.oldFilePath || !this.newFilePath) {
      console.error('Both files must be selected');
      return;
    }

    this.app.postMessage({
      kind: 'startComparison',
      oldFilePath: this.oldFilePath,
      newFilePath: this.newFilePath
    });
  }

  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  private showError(message: string): void {
    // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫Ôºå‰ΩøÁî®Á∫¢Ëâ≤Ê†∑ÂºèÂå∫ÂàÜ
    console.error(message);
    
    const toast = document.getElementById('copy-toast');
    const toastIcon = toast?.querySelector('.toast-icon');
    const toastText = toast?.querySelector('.toast-text');
    
    if (toast && toastIcon && toastText) {
      // ËÆæÁΩÆÈîôËØØÊ†∑Âºè
      toast.style.backgroundColor = 'var(--danger-color, #dc3545)';
      toast.style.color = '#ffffff';
      toastIcon.textContent = '‚úó'; // ÈîôËØØÂõæÊ†á
      toastText.textContent = message;
      toast.classList.remove('hidden', 'toast-hide');
      
      // 3ÁßíÂêéÈöêËóè
      setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => {
          toast.classList.add('hidden');
          // ÊÅ¢Â§çÈªòËÆ§Ê†∑Âºè
          toast.style.backgroundColor = '';
          toast.style.color = '';
          toastIcon.textContent = '‚úì';
        }, 300);
      }, 3000);
    }
  }

  private showSuccess(message: string): void {
    // ÁÆÄÂçïÁöÑÊàêÂäüÊèêÁ§∫ÔºåÂèØ‰ª•ÂêéÁª≠ÊîπËøõ
    console.log(message);
  }

  public getSelectedFiles(): { oldFilePath: string | null; newFilePath: string | null } {
    return {
      oldFilePath: this.oldFilePath,
      newFilePath: this.newFilePath
    };
  }
}
